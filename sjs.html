<!DOCTYPE html>
<html>
<head>
    <title>Self JavaScript Playground</title>

<script src="s.js"></script>

<style>
    * {
        font-family:monospace;
        font-size:104%;
        margin:0;
        background-color:black;
        color:#0F0;
        border: black solid 1px;
    }
    button, input, label {
        font-size:100%;
        color: #0F0;
        border: white solid 1px;
        padding-block: 1px;
        padding-inline: 6px;
    }
    b, textarea {
        font-family:monospace;
        background-color: #222;
        color: #0F0;
        border: white solid 1px;
    }
    div {
        font-face:monospace;
        background-color: white;
        color: black;
        width: 56em;
        //height: 24em;
        border: #ccc solid 1px;
    }
</style>

</head>
<body>

<!--<button type="button" onclick="load()">Load</button> -->
<input type="file" onchange="load(this)" id="files" style="display:none"/><label for="files">Load</label>
<button type="button" onclick="execute(false)">Run</button>
<button type="button" onclick="execute(true)">Debug</button>
<button type="button" onclick="parse()">Parse</button>
<button type="button" onclick="compile()">Compile</button>
<br>
<textarea contenteditable="true" id="textarea" rows="24" cols="80" ondrop="alert('TODO')" autofocus>
/*
    OCCHIO CHE SONO PIENO DI BUG!!!
*/
</textarea>
<br>
<span style="font-size:small">&copy; 2024 by Paolo Caressa</span>

<script>

let token_list = null;
let run_time = {debug: false};

function compile() {
    run_time = sjs_compile_block(sjs_scan(document.getElementsByTagName("textarea").textarea.value));
    console.log(run_time);
    let w = window.open("/", "Compiled Code");
    w.document.write("<h1>Compiled Code</h1><table>");
    for (let i = 0; i < run_time.code.length; ++ i) {
        w.document.write("<code>[" + i + "|" + run_time.code[i].l + ":" + run_time.code[i].c + "] ");
        if (run_time.code[i] && run_time.code[i].i.$name) {
            w.document.write(run_time.code[i].i.$name);
        } else {
            w.document.write(sjs_object2string(run_time.code[i].i));
        }
        w.document.write("</code></br>");
}}

function execute(debug) {
    console.log("Debug: " + debug);
    token_list = sjs_scan(document.getElementsByTagName("textarea").textarea.value);
    run_time = sjs_compile_block(token_list);
    sjs_run(run_time, debug);
}

function load(input) {
    let file = input.files[0];
    let reader = new FileReader();
    reader.onload = function() {
        document.getElementsByTagName("textarea").textarea.value = reader.result;
    };
    reader.onerror = function() {
        alert(reader.error);
    };
    reader.readAsText(file);
}

function parse() {
    token_list = sjs_scan(document.getElementsByTagName("textarea").textarea.value);
    console.log(token_list);
    let w = window.open("/", "Token List");
    w.document.write("<style> table, td, th, tr {padding: 3px; border:1px solid black; border-collapse: collapse;} th { font-weight:bold; } </style>");
    w.document.write("<h1>Token List</h1><table>");
    w.document.write("<tr><th> # </th><th> Token </th><th> Type </th><th> line:column</th></tr>");
    for (let i = 0; i < token_list.length; ++ i) {
        w.document.write("<tr><td>" + i + "</td><td><b style='font-family:courier new'>" + token_list[i].s + "</b></td><td>" + token_list[i].t + "</td><td>" + token_list[i].l + ":" + token_list[i].c + "</td></tr>");
    }
    w.document.write("</table>");
}

</script>

</body>
</html>
